# PR3 strict audit + segment filter consistency fixes

- Number: 7
- Created: 2026-02-19T15:13:35.289924
- File: `7.md`

## Details

Strict PR3 audit + fixes completed.

Audit scope checked
1) customer_analytics_viewmodel.dart
- TimeRange application and start/end boundary behavior
- Local day boundary bucketing
- Segment filter behavior for Trends (All/Work/Travel)
- travelEnabled=false behavior
- Exclusion of balance events in Trends totals

2) trends_tab.dart
- Searched for any remaining decimal-hour labels

3) tests
- Added tests for segment-based bucketing
- Added bucket sum invariant assertions

Violations found
1) Trends ignored segment filter (All/Work/Travel)
- File: lib/viewmodels/customer_analytics_viewmodel.dart
- Before: trends used always work + optional travel, independent of selected segment.
- Impact: Trends totals/buckets could differ from Overview when segment filter is Work or Travel.

2) ReportsScreen did not pass segment filter into Trends viewmodel
- File: lib/screens/reports_screen.dart
- Before: only date range and travelEnabled were wired to analytics model.
- Impact: Trends could not apply segment filter consistently.

3) TimeRange contains check used raw DateTime instead of normalized date-only in combined start+end path
- File: lib/viewmodels/customer_analytics_viewmodel.dart
- Before: `timeRange.contains(entry.date)`
- Impact: susceptible to time-component/UTC edge behavior; inconsistent with date-only fallback branch.

Fixes applied (minimal)
- customer_analytics_viewmodel.dart
  - Added trends segment state:
    - `EntryType? _trendsEntryTypeFilter`
    - `setTrendsEntryTypeFilter(EntryType? type)`
  - Trends data now uses segment-aware entry lists:
    - `_getTrendWorkEntries()`
    - `_getTrendTravelEntries()`
  - `trendsData` + `monthlyBreakdown` now consume segment-aware lists
  - `monthlyComparison` now uses tracked minutes for both work/travel entries through `_trackedMinutesForEntry`
  - Normalized TimeRange filtering to date-only before `contains(...)`

- reports_screen.dart
  - Added `_entryTypeForSegment(ReportSegment)` mapper
  - Wired selected segment into trends model:
    - `model.setTrendsEntryTypeFilter(_entryTypeForSegment(_selectedSegment));`

- trends_tab.dart
  - Re-audited: no remaining decimal-hour UI labels in Trends user-facing labels.
  - Labels are using `formatMinutes(...)` / `_formatTrackedMinutes(...)`.

Tests added/extended
- test/viewmodels/customer_analytics_viewmodel_test.dart
  - `trends apply inclusive date boundaries for selected range`
  - `trends segment filter controls bucketing and bucket sums`
    - checks All/Work/Travel behavior
    - checks sum(weeklyMinutes) == sum(monthly totalMinutes)
    - checks travel disabled => All totals equal Work totals

Verification commands run
- dart format lib/viewmodels/customer_analytics_viewmodel.dart lib/screens/reports_screen.dart test/viewmodels/customer_analytics_viewmodel_test.dart
- dart analyze lib/viewmodels/customer_analytics_viewmodel.dart lib/screens/reports/trends_tab.dart lib/screens/reports_screen.dart test/viewmodels/customer_analytics_viewmodel_test.dart
- flutter test test/viewmodels/customer_analytics_viewmodel_test.dart

All targeted checks passed.
