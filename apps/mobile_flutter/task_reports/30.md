# Single Source of Truth Audit for KvikTime (Home, Overview, Time Balance)

- Number: 30
- Created: 2026-02-24T13:12:51.327316
- File: `30.md`

## Details

**A) Screen-by-screen table**

| Screen | Metric | UI label | Source function (file:line) | Upstream dependency chain | Centralized? (Y/N) | Risk notes |
|---|---|---|---|---|---|---|
| Home | A) Balance today | `home_timeBalanceTitle` | `computeHomeYearlyPeriodSummary` (`lib/widgets/flexsaldo_card.dart:96`) | `HomeBalanceGlanceCard._buildBigBalance` (`lib/widgets/home_balance_glance_card.dart:152`) <- `UnifiedHomeScreen` (`lib/screens/unified_home_screen.dart:489-519`) <- `PeriodSummaryCalculator.compute` (`lib/reporting/period_summary_calculator.dart:11-57`) <- providers (`lib/screens/unified_home_screen.dart:482-505`) | Y | Includes travel when enabled; leave credit/planned time use PeriodSummary path (not TimeProvider path). |
| Home | D) Over/under plan (month) | `home_changeVsPlan` (month line) | month delta in (`lib/screens/unified_home_screen.dart:479`) | UI (`lib/widgets/home_balance_glance_card.dart:220-248`) <- `monthActual + monthCredit - monthTarget` (`lib/screens/unified_home_screen.dart:472-479`) <- `TimeProvider.monthActual/monthCredit/monthTargetToDate` (`lib/providers/time_provider.dart:963-1039`, `871-903`) | N | Separate formula path from year line. |
| Home | D) Over/under plan (year) | `home_changeVsPlan` (year line) | `PeriodSummary.differenceMinutes` via (`lib/screens/unified_home_screen.dart:522`) | UI (`lib/widgets/home_balance_glance_card.dart:251-285`) <- `yearSummary.differenceMinutes` <- `PeriodSummary.fromInputs` (`lib/reporting/period_summary.dart:36`) | Y | Different calculator path than month line. |
| Home | B) Opening/starting balance | component of Balance today | `startBalanceMinutes: openingFlexMinutes` in (`lib/widgets/flexsaldo_card.dart:121`) | `ContractProvider.openingFlexMinutes` (`lib/providers/contract_provider.dart:88`) <- passed from `UnifiedHomeScreen` (`lib/screens/unified_home_screen.dart:501-503`) | Y | Uses contract/profile baseline opening value directly. |
| Home | C) Adjustments (year-scoped) | component of Balance today | `_sumAdjustmentsInRangeMinutes` (`lib/widgets/flexsaldo_card.dart:78`) | `allAdjustments` (`lib/screens/unified_home_screen.dart:495-496`) <- range clip (`lib/widgets/flexsaldo_card.dart:106-111`) <- summed `deltaMinutes` (`lib/widgets/flexsaldo_card.dart:90`) | Y | Year-scoped and signed correctly; but differs from Overview period semantics. |
| Home | E) Planned time | implicit in month/year deltas | month target from `TimeProvider.monthTargetMinutesToDate` (`lib/providers/time_provider.dart:871`); year target from `PeriodSummaryCalculator` (`lib/reporting/period_summary_calculator.dart:41`) | Month path uses `_getScheduledMinutesForDate` (`lib/providers/time_provider.dart:154-188`, `891-900`) with `HolidayService.getRedDayInfo` (`lib/services/holiday_service.dart:341-355`); year path uses `TargetHoursCalculator.scheduledMinutesInRange` (`lib/utils/target_hours_calculator.dart:297-325`) | N | Month respects custom red day; year (PeriodSummary path) does not. |
| Home | F) Credited leave | implicit in deltas | month credit from `TimeProvider.monthCreditMinutesToDate` (`lib/providers/time_provider.dart:1003`); year credit from `PeriodSummaryCalculator` (`lib/reporting/period_summary_calculator.dart:33`) | Correct path month: `paidAbsenceMinutesForDate` (`lib/providers/absence_provider.dart:198-227`); year path: `summarizeLeaveMinutes -> normalizedLeaveMinutes` (`lib/reporting/leave_minutes.dart:24-34`) | N | High mismatch risk (75% full-day leave can become 8h in year path). |
| Home | G) Travel in balance math | none (implicit) | travel gate in (`lib/widgets/flexsaldo_card.dart:117`) | `SettingsProvider.isTravelLoggingEnabled` (`lib/screens/unified_home_screen.dart:503-505`) -> `TrackedTimeCalculator` includes travel if enabled (`lib/reporting/tracked_time_calculator.dart:26-29`) -> `accounted = trackedTotal + paidLeave` (`lib/reporting/period_summary.dart:34-36`) | N | Violates invariant \"travel never affects balance math\". |
| Overview | F) Credited leave (All) | `overview_creditedLeave` | card value from (`lib/screens/reports/overview_tab.dart:395`) | `periodSummary.paidLeaveMinutes` (`lib/screens/reports/overview_tab.dart:396`) <- `PeriodSummaryCalculator.compute` (`lib/screens/reports/overview_tab.dart:131-141`) <- `summarizeLeaveMinutes/normalizedLeaveMinutes` (`lib/reporting/period_summary_calculator.dart:33-35`, `lib/reporting/leave_minutes.dart:24-34`) | Y | Uses normalized leave, not schedule-based credited leave. |
| Overview | E) Planned time | `overview_plannedTime` | card value from (`lib/screens/reports/overview_tab.dart:420`) | `periodSummary.targetMinutes` <- `TargetHoursCalculator.scheduledMinutesInRange` (`lib/reporting/period_summary_calculator.dart:43-48`) with `SwedenHolidayCalendar` only | Y | Custom personal red day not propagated here. |
| Overview | D) Over/under plan | `overview_differenceVsPlan` | card value from (`lib/screens/reports/overview_tab.dart:434`) | `differenceMinutes` (`lib/reporting/period_summary.dart:36`) <- `accountedMinutes` includes tracked travel (`lib/reporting/period_summary.dart:34-35`) | Y | Depends on travelEnabled; can change when travel toggle changes. |
| Overview | B) Starting balance | `reportsCustom_balanceAtPeriodStart` | shown from (`lib/screens/reports/overview_tab.dart:745`) | `periodSummary.startBalanceMinutes` <- `summary.startingBalanceMinutes` (`lib/screens/reports/overview_tab.dart:139`) <- aggregator fold over opening+adjustments <= start (`lib/reports/report_aggregator.dart:326-339`) | Y | Uses report-query path (Supabase direct), not ContractProvider cache path. |
| Overview | C) Adjustments | `reportsCustom_timeAdjustmentsTotal` | shown from (`lib/screens/reports/overview_tab.dart:713`) | `periodSummary.manualAdjustmentMinutes` (`lib/screens/reports/overview_tab.dart:686`) <- `summary.balanceAdjustmentMinutesInRange` (`lib/screens/reports/overview_tab.dart:140`) <- `adjustmentsInRangeMinutes` (`lib/reports/report_aggregator.dart:166-167`) | Y | Signed correctly; period semantics differ from year-scoped Home/TimeBalance. |
| Overview | Balance at end of period | `overview_balanceAfterPeriod` | card value from (`lib/screens/reports/overview_tab.dart:447`) | `endBalanceMinutes = start + manualAdjustment + difference` (`lib/reporting/period_summary.dart:37-38`) | Y | Inherits leave/red-day/travel issues above. |
| Overview | G) Travel in balance math | travel cards + hidden influence | `travelEnabled` wiring in (`lib/screens/reports/overview_tab.dart:103`) | `ReportAggregator.buildSummary(...travelEnabled...)` (`lib/screens/reports/overview_tab.dart:100-105`, `lib/reports/report_aggregator.dart:232-236`) + `PeriodSummaryCalculator.compute(...travelEnabled...)` (`lib/screens/reports/overview_tab.dart:131-136`) | N | Travel affects balance when enabled. |
| Reports -> Time Balance | A) Balance today | `balance_balanceTodayHeadline` | local formula in (`lib/screens/reports/time_balance_tab.dart:152`) | `balanceToday = opening + yearlyAdjustment + (yearActual+yearCredit-yearTarget)` (`lib/screens/reports/time_balance_tab.dart:153-159`) <- TimeProvider methods (`lib/providers/time_provider.dart:1046-1119`, `910-941`, `789-811`) | N | Duplicated formula (not using PeriodSummary object). |
| Reports -> Time Balance | D) Over/under plan (month/year cards) | `balance_differenceVsPlan` | dashboard formulas in (`lib/widgets/time_balance_dashboard.dart:104`) and (`lib/widgets/time_balance_dashboard.dart:319`) | `variance = accounted - target` in widget <- inputs from tab (`lib/screens/reports/time_balance_tab.dart:100-137`, `178-193`) <- TimeProvider methods | N | Additional duplicated math layer in widget. |
| Reports -> Time Balance | E) Planned time | `balance_plannedTimeSinceBaseline` | shown in (`lib/widgets/time_balance_dashboard.dart:185`) and (`lib/widgets/time_balance_dashboard.dart:400`) | `targetForVariance = targetMinutesToDate ?? fullTarget` (`lib/widgets/time_balance_dashboard.dart:105`, `320`) <- tab passes to-date targets (`lib/screens/reports/time_balance_tab.dart:115-121`) <- red-day-aware schedule (`lib/providers/time_provider.dart:891-900`, `929-938`) | Y | This screen does respect custom red days (via TimeProvider path). |
| Reports -> Time Balance | F) Credited leave | `balance_creditedLeave` | shown in (`lib/widgets/time_balance_dashboard.dart:178`) and (`lib/widgets/time_balance_dashboard.dart:393`) | tab passes `monthCredit/yearCredit` (`lib/screens/reports/time_balance_tab.dart:132-137`) <- `paidAbsenceMinutesForDate` (`lib/providers/time_provider.dart:1035`, `1114`; `lib/providers/absence_provider.dart:198-227`) | Y | Correct contract/schedule-credit path. |
| Reports -> Time Balance | C) Adjustments/signs | headline subline + year row | sources in (`lib/screens/reports/time_balance_tab.dart:111`) and (`lib/widgets/time_balance_dashboard.dart:413`) | `yearAdjustmentMinutesToDate` (`lib/providers/time_provider.dart:789-811`) <- `totalAdjustmentMinutesInRange` (`lib/providers/balance_adjustment_provider.dart:188-191`) -> displayed signed (`lib/screens/reports/time_balance_tab.dart:233-236`, `lib/widgets/time_balance_dashboard.dart:474-476`) | Y | Sign handling is consistent. |
| Reports -> Time Balance | G) Travel never affects balance | informational-only expectation | work-only actuals in (`lib/providers/time_provider.dart:991`) and (`lib/providers/time_provider.dart:1072`) | Balance math uses `entry.workDuration`; dashboard `travelEnabled` only toggles details (`lib/widgets/time_balance_dashboard.dart:269-285`, `488-506`) | N | Math is safe, but tab hardcodes `travelEnabled: true` (`lib/screens/reports/time_balance_tab.dart:196-198`) so informational state can be wrong. |
| Exports | H) travel-only total minutes | Total row in minimal travel export | `prepareTravelMinimalExportData` (`lib/services/export_service.dart:236`) | Triggered by reports export dialog (`lib/screens/reports_screen.dart:465-470`) -> per-row adds `leg.minutes`/`travelMinutes` (`lib/services/export_service.dart:248-266`) -> total row (`lib/services/export_service.dart:269`) | N | Meets invariant (sum of rows). |
| Exports | H) leave-only normalized total minutes | Total row in minimal leave export | `prepareLeaveMinimalExportData` (`lib/services/export_service.dart:288`) | Triggered by reports export dialog (`lib/screens/reports_screen.dart:471-485`) -> per-row `normalizedLeaveMinutes` (`lib/services/export_service.dart:296`) -> total row (`lib/services/export_service.dart:306`) | N | Meets invariant for normalized totals. |
| Exports | H) full report (work/all) with start+adjustments+summary | Summary + Balance Events sheets | `exportReportSummaryToCSV/Excel` (`lib/services/export_service.dart:1178`) | Triggered by Overview tab export (`lib/screens/reports/overview_tab.dart:969-993`) -> `prepareReportExportData` (`lib/services/export_service.dart:608-659`) -> summary rows (`lib/services/export_service.dart:422-507`) + balance events (`lib/services/export_service.dart:535-593`) | Y | Full report path includes required components. |
| Exports | H) work/all from app-bar export dialog | entries-only export | `_performExport` default branch (`lib/screens/reports_screen.dart:486`) | `exportEntriesToCSV/Excel` (`lib/services/export_service.dart:1302-1398`) -> `prepareExportData` (`lib/services/export_service.dart:80-169`) | N | Does not include starting balance/adjustments/summary. |
| Exports | F) \"Paid leave credit / Ersatt franvaro\" rows | `exportSummary_paidLeaveCredit` | summary row in (`lib/services/export_service.dart:461`) and leave rows in (`lib/services/export_service.dart:376`) | Summary uses `periodSummary.paidLeaveMinutes` (PeriodSummary path); entries sheet paid leave rows use `normalizedLeaveMinutes` | N | Mismatch risk vs required `paidAbsenceMinutesForDate` crediting path. |

**B) Mismatch Risk List**

- `PeriodSummary` leave credit uses `normalizedLeaveMinutes` default `480` instead of schedule credit: `lib/reporting/period_summary_calculator.dart:33`, `lib/reporting/leave_minutes.dart:3`, `lib/reporting/leave_minutes.dart:24`. This can reproduce 75% full-day leave 8h vs 6h mismatch.
- Home mixes two formula paths: month (`TimeProvider`) vs year (`PeriodSummaryCalculator`): `lib/screens/unified_home_screen.dart:472`, `lib/screens/unified_home_screen.dart:489`. They differ on leave credit, travel handling, and custom red day handling.
- Overview planned time ignores personal red days because it uses `TargetHoursCalculator.scheduledMinutesInRange` with `SwedenHolidayCalendar` only: `lib/reporting/period_summary_calculator.dart:43`, `lib/screens/reports/overview_tab.dart:131`.
- Home year/Overview/full-report balance can include travel in balance math (`accounted = trackedTotal + leave`), controlled by travel toggle: `lib/reporting/tracked_time_calculator.dart:26`, `lib/reporting/period_summary.dart:34`, `lib/screens/unified_home_screen.dart:503`, `lib/screens/reports/overview_tab.dart:127`.
- Time Balance tab duplicates balance formulas locally and again in dashboard cards: `lib/screens/reports/time_balance_tab.dart:152`, `lib/widgets/time_balance_dashboard.dart:104`, `lib/widgets/time_balance_dashboard.dart:319`.
- Reports app-bar export `work/both` uses entries-only export (no start balance/adjustments/summary): `lib/screens/reports_screen.dart:486`, `lib/services/export_service.dart:1302`.
- Full report export still writes paid leave credit using normalized leave rows: `lib/services/export_service.dart:376`, `lib/services/export_service.dart:461`.
- Overview query path reads entries/absences/profile/adjustments directly from services, while Home/TimeBalance read providers; data freshness can diverge: `lib/reports/report_query_service.dart:140`, `lib/reports/report_query_service.dart:149`, `lib/reports/report_query_service.dart:240`, `lib/screens/unified_home_screen.dart:482`, `lib/screens/reports/time_balance_tab.dart:55`.
- Time Balance tab hardcodes `travelEnabled: true` for info display: `lib/screens/reports/time_balance_tab.dart:196`. Math is unaffected, but informational behavior can be wrong when travel is disabled.
- Custom red day storage/apply is present but not used in PeriodSummary path: storage `lib/repositories/user_red_day_repository.dart:11`, load/apply `lib/services/holiday_service.dart:230`, `lib/services/holiday_service.dart:341`, TimeProvider usage `lib/providers/time_provider.dart:154`, app wiring `lib/main.dart:295`.

**C) One True Model suggestion**

Use existing `PeriodSummary` (`lib/reporting/period_summary.dart:1`) as the single output model, but make `PeriodSummaryCalculator.compute` the only producer for Home, Overview, Time Balance, and full exports after it is upgraded to:
- credit leave via `AbsenceProvider.paidAbsenceMinutesForDate(date, scheduledMinutes)`,
- compute planned minutes via HolidayService-aware schedule,
- keep travel excluded from balance math (travel display remains informational).

**D) Fix plan (minimal diffs)**

1. Update `PeriodSummaryCalculator.compute` in `lib/reporting/period_summary_calculator.dart`.  
Replace `summarizeLeaveMinutes`/`normalizedLeaveMinutes` and holiday-only range target with daily callbacks so it uses schedule-aware credit and red-day-aware planned minutes.

2. Update Home year summary path in `lib/widgets/flexsaldo_card.dart` (used by `lib/screens/unified_home_screen.dart`).  
Call the upgraded calculator with the same leave-credit/schedule functions as TimeProvider and force travel exclusion for balance math.

3. Update Overview period summary path in `lib/screens/reports/overview_tab.dart`.  
Use the upgraded calculator inputs (same credit/schedule source), so `overview_creditedLeave`, `overview_plannedTime`, `difference`, and `endBalance` align with Home/TimeBalance.

4. Update Time Balance tab formulas in `lib/screens/reports/time_balance_tab.dart` and dashboard variance math in `lib/widgets/time_balance_dashboard.dart`.  
Consume one computed summary object instead of recomputing formulas in two UI layers.

5. Update full-report leave rows in `lib/services/export_service.dart`.  
Remove `normalizedLeaveMinutes` usage for credited-leave rows; use the same credited minutes source as the summary model.

6. Update app-bar export default `work/both` branch in `lib/screens/reports_screen.dart`.  
Route to `exportReportSummaryToCSV/Excel` instead of `exportEntriesToCSV/Excel` so starting balance + adjustments + summary are included.

7. Wire true travel setting in Time Balance tab info mode at `lib/screens/reports/time_balance_tab.dart`.  
Replace hardcoded `true` with `SettingsProvider.isTravelLoggingEnabled`.

**E) Regression tests to add**

1. **75% contract full-day leave => 6h credited everywhere**  
Assert `Home year`, `Overview credited leave`, `Reports Time Balance credited leave`, and `full report summary paid leave credit` all resolve full-day leave to scheduled minutes (e.g., 360), not 480.

2. **custom red day => planned=0 everywhere**  
With a personal full red day in range, assert planned minutes drop by that day in Home/Overview/Time Balance and full-report `Planned` row.

3. **travel toggle never changes Balance today**  
With travel entries present, toggling travel logging must not change `Balance today`/`Over-under` on Home, Overview balance math, and Reports Time Balance headline/cards.

4. **adjustment + and - signs consistent everywhere**  
For mixed positive/negative adjustments, assert same signed totals in Home components, Overview adjustments/start/end balances, Time Balance headline/year card, and export summary/balance-events sheets.
