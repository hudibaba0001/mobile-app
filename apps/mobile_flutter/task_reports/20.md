# Tracking Start Date Init + Effective Range Visibility

- Number: 20
- Created: 2026-02-20T00:18:21.132462
- File: `20.md`

## Details

Implemented trackingStartDate initialization + effective tracking range visibility across Home/Overview/Export without changing tracked-time business meaning.

What was already in code and validated:
- Auto-init logic exists and is wired from first Home load and provider updates:
  - lib/providers/contract_provider.dart
    - deriveInitialTrackingStartDate(...) at line 237
    - ensureTrackingStartDateInitialized(...) at line 265
    - fallback getter trackingStartDate defaults to today date-only at line 53
  - lib/screens/unified_home_screen.dart
    - _ensureTrackingStartDateInitialized() called in init + data change listeners (lines 104, 111, 115)
    - loads entry years + absences and persists tracking start once (lines 138, 151)
- Home yearly formula already uses clipped year range and minute-based PeriodSummary path:
  - lib/widgets/flexsaldo_card.dart
    - computeHomeYearlyBalanceMinutes(...) at line 89
    - effectiveYearRange = thisYear.clipStart(trackingStartDate) at line 100

Changes in this task:
1) Overview export now passes tracking/effective range metadata
- lib/screens/reports/overview_tab.dart
  - derive trackingStartDate + effectiveStart from selected range at lines 948-954
  - pass trackingStartDate + effectiveRangeStart to CSV/Excel export calls at lines 967-986

2) XLSX export now displays selected period + effective tracking range and tracking-start note
- lib/services/export_service.dart
  - buildReportSummaryWorkbookBytes now accepts trackingStartDate/effectiveRangeStart (line 570)
  - workbook builder passes metadata into styled sheet writers (lines 597, 632, 641)
  - Summary (Easy) adds top metadata rows:
    - "Report period: ..." at line 824
    - "Effective tracking range: ..." at line 826
  - Balance Events adds top note row:
    - "Tracking start date: ..." at line 995
  - exportReportSummaryToCSV/Excel signatures accept metadata params (lines 1076, 1131)

3) Tests added/extended
- test/providers/contract_provider_tracking_start_date_test.dart
  - no entries/absences => today
  - earliest activity => earliest date
- test/reporting/period_summary_calculator_test.dart
  - clipping test ensures selected range start is clipped to trackingStartDate (line 171)
  - verifies tracked/leave/target are computed from effective range
- test/services/export_service_test.dart
  - new XLSX metadata parity test (line 643)
  - asserts Summary metadata rows + minute parity + Balance Events tracking note
- test/widgets/tracking_range_text_test.dart
  - widget assertions for Home and Overview tracking/effective range text

Verification commands run:
- flutter test test/providers/contract_provider_tracking_start_date_test.dart
- flutter test test/reporting/period_summary_calculator_test.dart
- flutter test test/services/export_service_test.dart
- flutter test test/widgets/tracking_range_text_test.dart
- flutter test (full suite) -> fails due unrelated pre-existing tests:
  - test/admin/admin_users_screen_test.dart missing screen import
  - test/widgets/time_balance_dashboard_test.dart outdated constructor args
- flutter analyze -> fails due unrelated pre-existing issues (same two test areas) + existing warnings in main.dart/login_screen.dart

Result:
- trackingStartDate initialization behavior is covered by tests and remains idempotent.
- PeriodSummary clipping is validated for selected range < trackingStartDate.
- Overview export now carries effective range context into XLSX.
- XLSX now clearly shows selected period vs effective tracking range and tracking start note.
