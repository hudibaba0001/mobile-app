# Overview PeriodSummary Contract

- Number: 15
- Created: 2026-02-19T21:52:03.058480
- File: `15.md`

## Details

Implemented Overview-first reporting contract via a new shared PeriodSummary (minutes-based), then switched Overview cards to consume only that contract and added tests.

What was added:
- `lib/reporting/period_summary.dart`
  - New `PeriodSummary` model with required fields:
    - work_minutes, travel_minutes, tracked_total_minutes
    - paid_leave_minutes
    - accounted_minutes = tracked_total + paid_leave
    - target_minutes
    - difference_minutes = accounted - target
    - start_balance_minutes, manual_adjustment_minutes
    - end_balance_minutes = start_balance + manual_adjustment + difference
  - Canonical formulas enforced in `PeriodSummary.fromInputs(...)`.

- `lib/reporting/period_summary_calculator.dart`
  - New calculator to compute `PeriodSummary` from:
    - entries, absences, TimeRange, travelEnabled
    - weeklyTargetMinutes + SwedenHolidayCalendar
    - trackingStartDate, startBalanceMinutes, manualAdjustmentMinutes
  - Uses shared calculators/helpers:
    - `TrackedTimeCalculator` for tracked split/totals
    - `summarizeLeaveMinutes` for paid leave credits
    - `TargetHoursCalculator.scheduledMinutesInRange` with tracking-start clipping

Overview wiring changes:
- `lib/screens/reports/overview_tab.dart`
  - Replaced duplicate per-card math with single `_buildPeriodSummary(summary)` call.
  - `All` segment cards now render values from `PeriodSummary` only.
  - Updated card labels to cleaner wording:
    - Total logged time
    - Paid leave
    - Accounted time
    - Planned time
    - Difference vs plan
    - Your balance after this period
  - Added merged period list model for UI rows (`_OverviewPeriodItem`) and combined list builder.
  - `Entries in period` now includes leave rows in `All` segment so days are not missing.
  - Tracked totals still exclude leave (from tracked calculator path).
  - Balance section now uses `PeriodSummary` balance fields for start/adjustment/end display totals.

Tests added:
- `test/reporting/period_summary_calculator_test.dart`
  - Seed-style formula test: target 120h, tracked 112h, leave 8h -> diff 0.
  - Calculator test: paid leave included, unpaid leave excluded, out-of-range records excluded.
  - Travel-disabled test: travel=0 while leave still contributes to accounted.

Validation run:
- `dart format` on modified files.
- `flutter test test/reporting/period_summary_calculator_test.dart`
- `flutter test test/reporting test/reports/report_aggregator_test.dart`
- `flutter analyze lib/screens/reports/overview_tab.dart lib/reporting/period_summary.dart lib/reporting/period_summary_calculator.dart`
- All passed.
