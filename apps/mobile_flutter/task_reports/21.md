# Welcome Setup + Baseline UX + Calculated-From Wording

- Number: 21
- Created: 2026-02-20T01:05:03.441460
- File: `21.md`

## Details

Implemented onboarding/baseline UX update centered on Welcome Setup + clearer range wording, while keeping minute-based calculators and business logic intact.

Changes made:

1) Added setup state and onboarding settings in SettingsProvider
- File: lib/providers/settings_provider.dart
- Added persisted, user-scoped fields:
  - paid leave tracking toggle (default ON)
  - setup completed flag (default false)
  - baseline date
- Added getters/setters:
  - isPaidLeaveTrackingEnabled / setPaidLeaveTrackingEnabled(...)
  - isSetupCompleted / setSetupCompleted(...)
  - baselineDate / setBaselineDate(...)
- Kept existing cloud sync for dark mode/travel/time-balance only (no schema change).

2) Added post-paywall Welcome Setup screen
- File: lib/screens/welcome_setup_screen.dart (new)
- New flow with one-screen setup:
  - mode: Employee vs Freelancer
  - toggles: Travel time logging + Paid leave tracking
  - employee section:
    - "Balance baseline (from employer)"
    - editable baseline date (default today/local)
    - baseline parser for +/- hour inputs (e.g. +29h, -5h, +29h 30m)
    - helper/warning text
    - Contract settings CTA opens existing ContractSettingsScreen
  - sticky bottom actions:
    - Skip for now -> freelancer-safe defaults + setupCompleted=true
    - Continue -> validates employee contract and baseline input, persists baseline/tracking start/opening minutes, setupCompleted=true

3) Gate flow after entitlement
- File: lib/screens/account_status_gate.dart
- After legal + active entitlement checks:
  - if settings.isSetupCompleted == false => show WelcomeSetupScreen
  - on completion => route to Home

4) Overview UI behavior for freelancer mode (no balance cards)
- File: lib/screens/reports/overview_tab.dart
- Added mode-aware visibility using settings.isTimeBalanceEnabled:
  - hide balance/plan cards (Accounted, Planned, Difference, Balance after period)
  - hide Balance adjustments section
- Tracked cards and lists remain available.

5) Export wording updates (XLSX metadata)
- File: lib/services/export_service.dart
- Updated labels:
  - "Effective tracking range" -> "Calculated from"
  - "Tracking start date" -> "Baseline date"
- Applies to Summary (Easy) metadata and Balance Events note row.

6) Tests added/updated
- New: test/widgets/welcome_setup_screen_test.dart
  - Employee mode requires contract before continue
  - Freelancer mode can continue without contract
- Updated: test/services/export_service_test.dart
  - expects "Calculated from" and "Baseline date" metadata text
- Updated: test/widgets/tracking_range_text_test.dart
  - verifies Home/Overview wording uses baseline + calculated-from strings
- Updated: test/widgets/flexsaldo_card_test.dart
  - baseline-today/no-entries case keeps yearly value at baseline in this fixture (Sunday)

Verification commands run:
1) flutter test test/widgets/welcome_setup_screen_test.dart
   - PASS
2) flutter test test/reporting test/services test/widgets
   - FAIL (pre-existing unrelated failures):
     - test/services/csv_exporter_test.dart (expects old section header format)
     - test/widgets/time_balance_dashboard_test.dart (constructor params out of date)
3) flutter analyze
   - FAIL due pre-existing unrelated issues in repo:
     - splash_screen animate method mismatch
     - missing admin screen test import
     - stale time_balance_dashboard_test named args

Targeted checks for touched files passed:
- flutter analyze lib/providers/settings_provider.dart lib/screens/welcome_setup_screen.dart lib/screens/account_status_gate.dart lib/screens/reports/overview_tab.dart lib/services/export_service.dart test/widgets/welcome_setup_screen_test.dart test/widgets/tracking_range_text_test.dart test/widgets/flexsaldo_card_test.dart test/services/export_service_test.dart
  - PASS

Notes:
- Calculation source of truth remains unchanged (tracked/accounted/balance formulas still flow through existing minute-based calculators).
- This change mainly improves setup defaults and clarifies user-facing interpretation via baseline + calculated-from messaging.
