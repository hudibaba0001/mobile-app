# Export Alignment to PeriodSummary

- Number: 16
- Created: 2026-02-19T22:04:50.804687
- File: `16.md`

## Details

Implemented export alignment to the PeriodSummary contract (Overview-first order), including leave rows, summary sheet, and balance events sheet.

Changes:
- Updated `lib/services/export_service.dart`:
  - Extended `ReportExportLabels` to include summary/balance sheet names and summary metric labels.
  - Added report-entry builder that keeps fixed 20-column schema and includes paid leave rows:
    - Leave rows use type labels: Leave (Sick/VAB/Paid Vacation)
    - Date set
    - Minutes placed in Span Minutes
    - Worked Minutes left empty
    - Entry Notes explain credited leave (not worked)
  - Report totals row now explicitly labeled `TOTAL (tracked only)` and sums only tracked work/travel.
  - Added Summary sheet generation from `PeriodSummary`:
    - Total logged time
    - Paid leave
    - Accounted time
    - Planned time
    - Difference vs plan
    - Your balance after this period
  - Added Balance Events sheet for opening balance + manual adjustments + start/end balances.
  - `prepareReportExportData` now accepts `periodSummary` and returns 3 sheets.
  - Updated CSV/XLSX report export methods to require and pass `periodSummary`.

- Updated `lib/screens/reports/overview_tab.dart`:
  - Report export labels now include:
    - Sheet names: Summary (Easy), Balance Events
    - Cleaner metric labels required by Product
  - `_exportSummary` now computes and passes `periodSummary` to export calls.

- Added/extended tests in `test/services/export_service_test.dart`:
  - New test verifies report export summary values match `PeriodSummaryCalculator` outputs for the same range.
  - Verifies paid leave rows appear in Report sheet.
  - Verifies unpaid leave rows are excluded from Report leave rows.
  - Verifies tracked totals row remains tracked-only and is not inflated by leave.

Validation run:
- `flutter test test/services/export_service_test.dart`
- `flutter test test/reporting/period_summary_calculator_test.dart test/reporting/accounted_time_calculator_test.dart test/reports/report_aggregator_test.dart`
- `flutter analyze lib/services/export_service.dart lib/screens/reports/overview_tab.dart test/services/export_service_test.dart`

Notes:
- Had temporary disk-full issue during test run; resolved by running `flutter clean` and rerunning tests.
