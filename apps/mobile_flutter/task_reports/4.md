# PR3 Trends Source-of-Truth Alignment

- Number: 4
- Created: 2026-02-19T14:51:18.031589
- File: `4.md`

## Details

PR3 implemented: Reports > Trends now uses minute-based source of truth and selected report period.

Scope completed
- Wired selected period from ReportsScreen into TrendsTab using TimeRange.
- TrendsTab now receives `TimeRange range` and syncs it to `CustomerAnalyticsViewModel.setDateRange(...)`.
- ReportsScreen now also passes travel-enabled state into viewmodel via `setTravelEnabled(...)`.

Core calculation changes (Trends path)
- In CustomerAnalyticsViewModel:
  - `MonthlyBreakdown` converted from hour doubles to canonical minute ints:
    - `workMinutes`
    - `travelMinutes`
    - `totalMinutes`
  - Trends data now returns `weeklyMinutes` (List<int>) and daily trend maps with minute fields:
    - `workMinutes`
    - `travelMinutes`
    - `totalMinutes`
  - Removed Trends dependency on server-hour payload for displayed metrics so Trends uses same local minute-based source.
  - Added travel feature toggle handling in trends path (`setTravelEnabled`, zero travel when disabled).
  - Work minute source in trends now uses `entry.workDuration.inMinutes` (canonical field).
  - Daily trends window now respects selected date range and no longer hardcodes "last 7 days from now" outside selected range.

Trends UI display changes
- Replaced decimal-hour labels with `formatMinutes(...)` across Trends UI:
  - Monthly work/travel/total cells
  - Monthly target and variance labels
  - Daily cards total/work/travel labels
  - Weekly chart axis labels now format minute-equivalent text (chart bars still render in hours doubles)
- No user-facing decimal `X.Xh` labels remain in Trends tab.

Files changed
- lib/screens/reports/trends_tab.dart
- lib/screens/reports_screen.dart
- lib/viewmodels/customer_analytics_viewmodel.dart
- test/viewmodels/customer_analytics_viewmodel_test.dart

Tests and verification
- Added test: `trends use minute buckets for selected range and travel toggle`
  - Validates range filtering/bucketing in minutes
  - Validates travel disabled => travel minutes excluded
- Ran:
  - `flutter test test/viewmodels/customer_analytics_viewmodel_test.dart` (pass)
  - `dart analyze lib/screens/reports/trends_tab.dart lib/screens/reports_screen.dart lib/viewmodels/customer_analytics_viewmodel.dart test/viewmodels/customer_analytics_viewmodel_test.dart` (no issues)
- Note: full `flutter analyze` still reports pre-existing unrelated admin test URI errors in this repo.

Requested PR note
- "Trends now respects the selected report period and uses the same minute-based calculator/format as Home/Overview."
