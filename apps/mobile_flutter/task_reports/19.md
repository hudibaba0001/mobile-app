# Home yearly balance includes adjustments

- Number: 19
- Created: 2026-02-19T22:45:02.939358
- File: `19.md`

## Details

Fixed Home yearly balance formula path to include manual adjustment events in year-to-date saldo while keeping month cards unchanged.

What was changed:
- Home yearly balance is now computed via a shared minute-based path using TimeRange + PeriodSummaryCalculator + explicit in-range adjustment sum.
- Year range now uses local day boundaries: Jan 1 -> today (endExclusive).
- Manual adjustments are summed from adjustment events with [startInclusive, endExclusive) logic and included in yearly saldo.
- Monthly Home status math remains unchanged and isolated from opening balance/adjustments.

Code updates:
1) lib/widgets/flexsaldo_card.dart
- Added testable helper functions:
  - computeHomeMonthlyStatusMinutes(...)
  - computeHomeYearlyBalanceMinutes(...)
- Added internal adjustment range reducer for year-range minute sum.
- Updated FlexsaldoCard build path to:
  - read entries/absences/adjustments/settings providers
  - compute yearly balance through PeriodSummaryCalculator with opening balance + in-range adjustments
  - keep month status from monthActual + monthCredit - monthTargetToDate only

2) test/widgets/flexsaldo_card_test.dart
- Replaced outdated widget-only assertions with formula tests:
  - opening + adjustment + period difference scenario:
    startBalance=+600, adjustment=-120, period difference=+315 => yearly=+795
  - monthly status invariance test showing monthly status stays unchanged with opening/adjustment events present.

Verification run:
- flutter test test/widgets/flexsaldo_card_test.dart
- flutter analyze lib/widgets/flexsaldo_card.dart test/widgets/flexsaldo_card_test.dart
- flutter analyze (full) => fails due unrelated pre-existing issues in admin test import + unused import in overview_tab

Notes:
- Did not modify monthly home card formulas beyond extracting same formula into helper.
- Did not change Home/Overview tracked business meaning; fix is limited to yearly Home saldo calculation path.
