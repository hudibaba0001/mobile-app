# Leaves vs Tracked Source of Truth

- Number: 12
- Created: 2026-02-19T16:20:42.461101
- File: `12.md`

## Details

Implemented tracked vs credited/accounted consistency for Reports Overview and Trends monthly comparison.

Scope completed:
- Added shared minute-based domain helpers:
  - lib/reporting/leave_minutes.dart
  - lib/reporting/accounted_time_summary.dart
  - lib/reporting/accounted_time_calculator.dart
- Updated report aggregator leave semantics:
  - LeavesSummary now exposes paid/credited and unpaid minute getters.
  - Full-day leave normalization now uses shared helper (0 minutes => 480 by default).
- Updated Reports > Overview (All segment cards):
  - Explicit metrics now shown: Work, Travel, Tracked, Leave, Accounted, Target, Delta, Entries.
  - Tracked uses tracked-time calculator only (work+travel, break-aware via workDuration).
  - Leave uses paid leave minutes only (vacation/sick/VAB).
  - Accounted = tracked + paid leave.
  - Target computed in minutes for selected range using weekly contract target + holiday-aware scheduledMinutesInRange, clamped by trackingStartDate.
  - Delta = accounted - target.
- Updated Reports > Trends monthly comparison:
  - Leave aggregation switched from day-count chips to minute-based per leave type.
  - Monthly comparison now computes and displays Work, Travel, Leave, Accounted, Target, Delta.
  - Delta uses Accounted - Target (not tracked - target).
  - Target computed directly in minutes via TargetHoursCalculator.monthlyScheduledMinutes.
  - Daily/weekly trends remain tracked-only.
  - Absence loading now follows selected range years instead of now/year-1 hardcoding.
- Added localization keys for explicit labels:
  - reportsMetric_tracked, reportsMetric_leave, reportsMetric_accounted, reportsMetric_delta,
    reportsMetric_trackedPlusLeave, reportsMetric_accountedMinusTarget
  - Updated app_en.arb/app_sv.arb and regenerated l10n outputs.
- Added tests:
  - test/reporting/accounted_time_calculator_test.dart
    - target 120h, tracked 112h, leave 8h => accounted 120h, delta 0
    - leave does not change tracked totals
    - travelEnabled=false keeps travel=0 while leave still contributes to accounted
  - Extended test/reports/report_aggregator_test.dart
    - paid leave credited, unpaid leave excluded from credited, tracked remains entries-only.

Verification run:
- dart analyze on changed files: no issues
- flutter test:
  - test/reporting/accounted_time_calculator_test.dart
  - test/reports/report_aggregator_test.dart
  - test/viewmodels/customer_analytics_viewmodel_test.dart
  - all passed
